# This file is part of tcollector.
# Copyright (C) 2011  The tcollector Authors.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or (at your
# option) any later version.  This program is distributed in the hope that it
# will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser
# General Public License for more details.  You should have received a copy
# of the GNU Lesser General Public License along with this program.  If not,
# see <http://www.gnu.org/licenses/>.

# This Makefile is a complete train wreck.  I'm sorry.  --tsuna

PACKAGE_VERSION := 1.2.1
RPM_REVISION := 1
# Where do we install our files.
tcollectordir := /usr/local/tcollector

# Various commands we need.
MKDIR_P := mkdir -p
CP_P := cp -p
# In some environment this command can be called `gsha1sum' or `digest'.
SHA1SUM := sha1sum
ZIP := zip -9
PYTHON_VERSION := 2.7
PYTHON := python$(PYTHON_VERSION)

# Our "source tree" is in the parent directory, always.
VPATH := ..

git_version := \
  `git rev-list --pretty=format:%h HEAD --max-count=1 | sed 1d || echo unknown`
git_fullsha1 := \
  `git rev-list --pretty=format:%H HEAD --max-count=1 | sed 1d || echo unknown`

# What / where do we build.
DESTDIR := destdir
RPM_TARGET := noarch
BASENAME := tcollector-$(PACKAGE_VERSION)-$(RPM_REVISION)
RPM := $(BASENAME).$(RPM_TARGET).rpm
EOSRPM := tcollector-eos-$(PACKAGE_VERSION)-$(RPM_REVISION).$(RPM_TARGET).rpm
SWIX := $(BASENAME).swix

all: rpm swix

swix: manifest.txt
	cd $(RPM_TARGET) && $(ZIP) $(SWIX) $(EOSRPM) $(RPM) $^

manifest.txt:
	set -e; { \
          echo 'format: 1'; \
          echo 'primaryRpm: $(EOSRPM)'; \
					echo -n '$(EOSRPM)-sha1: '; \
					set `$(SHA1SUM) "noarch/$(EOSRPM)"`; \
					echo $$1; \
					echo -n '$(RPM)-sha1: '; \
					set `$(SHA1SUM) "noarch/$(RPM)"`; \
					echo $$1; \
        } > $(RPM_TARGET)/$@

rpm:
	set -e; { \
          echo "# File generated by Makefile, do not edit"; \
	  sed \
            -e 's/@PACKAGE_VERSION@/$(PACKAGE_VERSION)/' \
            -e 's/@PYTHON_VERSION@/$(PYTHON_VERSION)/' \
            -e "s/@GIT_SHORTSHA1@/$(git_version)/" \
            -e "s/@GIT_FULLSHA1@/$(git_fullsha1)/" \
            -e 's/@RPM_REVISION@/$(RPM_REVISION)/' \
	    tcollector.spec; \
        } >tcollector-t.spec

		@rpmbuild --define "_topdir %(pwd)/" \
							--define "_sourcedir %(pwd)/dist/" \
							--define "_rpmdir %(pwd)" \
							--define "_srcrpmdir %{_topdir}" \
				-ba tcollector-t.spec

clean:
	rm -rf BUILD BUILDROOT SPECS SOURCES dist noarch
	rm -f *.rpm
	rm -f *.swix
	rm -f tcollector-t.spec
	rm -f tcollector
	rm -rf "$(DESTDIR)/$(tcollectordir)"
	rm -f $(DESTDIR)/etc/init.d/tcollector
	rm -f $(DESTDIR)/usr/bin/tcollector
	rm -f $(DESTDIR)/usr/lib/python$(PYTHON_VERSION)/site-packages/tcollector_agent.py*
	@test -d "$(DESTDIR)" || exit 0; \
        find "$(DESTDIR)" -depth -type d \
        | while read dir; do \
          echo rmdir "'$$dir'"; \
          rmdir "$$dir" || exit $$?; \
        done
	rm -f common.spec $(RPM_SPEC) $(EOSRPM_SPEC) filelist manifest.txt $(EOSRPM)
	@rm -f .dist-stamp

distclean: clean
	rm -f $(SWIX) $(RPM)

.PHONY: all rpm clean distclean
.SUFFIXES: .spec .rpm
